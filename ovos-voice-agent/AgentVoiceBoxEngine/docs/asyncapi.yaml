asyncapi: 2.6.0
info:
  title: AgentVoiceBox WebSocket API
  version: 1.0.0
  description: |
    Django Channels WebSocket endpoints for AgentVoiceBox.
    Authentication uses Keycloak JWTs passed as `?token=` or `Authorization: Bearer`.

servers:
  local:
    url: ws://localhost:65020
    protocol: ws
    description: Local development

channels:
  /ws/v2/events:
    description: Tenant/user event stream.
    publish:
      message:
        oneOf:
          - $ref: '#/components/messages/Subscribe'
          - $ref: '#/components/messages/Unsubscribe'
          - $ref: '#/components/messages/Ping'
    subscribe:
      message:
        oneOf:
          - $ref: '#/components/messages/Connected'
          - $ref: '#/components/messages/Subscribed'
          - $ref: '#/components/messages/Unsubscribed'
          - $ref: '#/components/messages/Notification'
          - $ref: '#/components/messages/Billing'
          - $ref: '#/components/messages/Session'
          - $ref: '#/components/messages/System'
          - $ref: '#/components/messages/Pong'

  /ws/v2/sessions/{session_id}:
    description: Real-time voice session channel.
    parameters:
      session_id:
        description: Session UUID
        schema:
          type: string
    publish:
      message:
        oneOf:
          - $ref: '#/components/messages/SessionUpdate'
          - $ref: '#/components/messages/AudioInput'
          - $ref: '#/components/messages/ResponseCreate'
          - $ref: '#/components/messages/ResponseCancel'
          - $ref: '#/components/messages/Ping'
    subscribe:
      message:
        oneOf:
          - $ref: '#/components/messages/SessionConnected'
          - $ref: '#/components/messages/SessionUpdated'
          - $ref: '#/components/messages/TranscriptionCompleted'
          - $ref: '#/components/messages/ResponseStarted'
          - $ref: '#/components/messages/ResponseChunk'
          - $ref: '#/components/messages/ResponseCompleted'
          - $ref: '#/components/messages/AudioOutput'
          - $ref: '#/components/messages/Pong'

  /ws/v2/stt/transcription:
    description: Streaming STT endpoint.
    publish:
      message:
        oneOf:
          - $ref: '#/components/messages/STTConfig'
          - $ref: '#/components/messages/STTAudioChunk'
          - $ref: '#/components/messages/Ping'
    subscribe:
      message:
        oneOf:
          - $ref: '#/components/messages/STTReady'
          - $ref: '#/components/messages/TranscriptionPartial'
          - $ref: '#/components/messages/TranscriptionFinal'
          - $ref: '#/components/messages/Pong'

  /ws/v2/tts/stream:
    description: Streaming TTS endpoint.
    publish:
      message:
        oneOf:
          - $ref: '#/components/messages/TTSConfig'
          - $ref: '#/components/messages/TTSSynthesize'
          - $ref: '#/components/messages/TTSCancel'
          - $ref: '#/components/messages/Ping'
    subscribe:
      message:
        oneOf:
          - $ref: '#/components/messages/TTSReady'
          - $ref: '#/components/messages/TTSStarted'
          - $ref: '#/components/messages/TTSConfigured'
          - $ref: '#/components/messages/TTSCancelled'
          - $ref: '#/components/messages/TTSAudio'
          - $ref: '#/components/messages/TTSCompleted'
          - $ref: '#/components/messages/Pong'

components:
  messages:
    Ping:
      name: ping
      payload:
        type: object
        properties:
          type:
            const: ping
    Pong:
      name: pong
      payload:
        type: object
        properties:
          type:
            const: pong

    Subscribe:
      name: subscribe
      payload:
        type: object
        properties:
          type:
            const: subscribe
          event_types:
            type: array
            items:
              type: string
    Unsubscribe:
      name: unsubscribe
      payload:
        type: object
        properties:
          type:
            const: unsubscribe
          event_types:
            type: array
            items:
              type: string

    Connected:
      name: connected
      payload:
        type: object
        properties:
          type:
            const: connected
          data:
            type: object

    Subscribed:
      name: subscribed
      payload:
        type: object
        properties:
          type:
            const: subscribed
          data:
            type: object

    Unsubscribed:
      name: unsubscribed
      payload:
        type: object
        properties:
          type:
            const: unsubscribed
          data:
            type: object

    Notification:
      name: notification
      payload:
        type: object
        properties:
          type:
            const: notification
          data:
            type: object

    Billing:
      name: billing
      payload:
        type: object
        properties:
          type:
            const: billing
          data:
            type: object

    Session:
      name: session
      payload:
        type: object
        properties:
          type:
            const: session
          data:
            type: object

    System:
      name: system
      payload:
        type: object
        properties:
          type:
            const: system
          data:
            type: object

    SessionUpdate:
      name: session.update
      payload:
        type: object
        properties:
          type:
            const: session_update
          config:
            type: object

    SessionConnected:
      name: session.connected
      payload:
        type: object
        properties:
          type:
            const: session.connected
          data:
            type: object

    SessionUpdated:
      name: session.updated
      payload:
        type: object
        properties:
          type:
            const: session.updated
          data:
            type: object

    AudioInput:
      name: audio.input
      payload:
        type: object
        properties:
          type:
            const: audio_input
          audio:
            type: string
            description: Base64-encoded audio

    AudioOutput:
      name: audio.output
      payload:
        type: object
        properties:
          type:
            const: audio.output
          data:
            type: object

    ResponseCreate:
      name: response.create
      payload:
        type: object
        properties:
          type:
            const: response_create

    ResponseCancel:
      name: response.cancel
      payload:
        type: object
        properties:
          type:
            const: response_cancel

    ResponseStarted:
      name: response.started
      payload:
        type: object
        properties:
          type:
            const: response.started
          data:
            type: object

    ResponseChunk:
      name: response.chunk
      payload:
        type: object
        properties:
          type:
            const: response.chunk
          data:
            type: object

    ResponseCompleted:
      name: response.completed
      payload:
        type: object
        properties:
          type:
            const: response.completed
          data:
            type: object

    TranscriptionCompleted:
      name: transcription.completed
      payload:
        type: object
        properties:
          type:
            const: transcription.completed
          data:
            type: object

    STTReady:
      name: stt.ready
      payload:
        type: object
        properties:
          type:
            const: stt.ready
          data:
            type: object

    STTConfig:
      name: stt.config
      payload:
        type: object
        properties:
          type:
            const: config
          model:
            type: string
          language:
            type: string

    STTAudioChunk:
      name: stt.audio
      payload:
        type: object
        properties:
          type:
            const: audio_chunk
          audio:
            type: string
          is_final:
            type: boolean

    TranscriptionPartial:
      name: transcription.partial
      payload:
        type: object
        properties:
          type:
            const: transcription.partial
          data:
            type: object

    TranscriptionFinal:
      name: transcription.final
      payload:
        type: object
        properties:
          type:
            const: transcription.final
          data:
            type: object

    TTSReady:
      name: tts.ready
      payload:
        type: object
        properties:
          type:
            const: tts.ready
          data:
            type: object

    TTSConfig:
      name: tts.config
      payload:
        type: object
        properties:
          type:
            const: config
          voice_id:
            type: string
          speed:
            type: number
          format:
            type: string

    TTSSynthesize:
      name: tts.synthesize
      payload:
        type: object
        properties:
          type:
            const: synthesize
          text:
            type: string
          voice_id:
            type: string
          speed:
            type: number

    TTSCancel:
      name: tts.cancel
      payload:
        type: object
        properties:
          type:
            const: cancel

    TTSStarted:
      name: tts.started
      payload:
        type: object
        properties:
          type:
            const: tts.started
          data:
            type: object

    TTSConfigured:
      name: tts.configured
      payload:
        type: object
        properties:
          type:
            const: tts.configured
          data:
            type: object

    TTSCancelled:
      name: tts.cancelled
      payload:
        type: object
        properties:
          type:
            const: tts.cancelled
          data:
            type: object

    TTSAudio:
      name: tts.audio
      payload:
        type: object
        properties:
          type:
            const: tts.audio
          data:
            type: object

    TTSCompleted:
      name: tts.completed
      payload:
        type: object
        properties:
          type:
            const: tts.completed
          data:
            type: object
