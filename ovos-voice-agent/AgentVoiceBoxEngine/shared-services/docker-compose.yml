# ==========================================================================
# SHARED SERVICES - Development Infrastructure (Accessible by All Programs)
# ==========================================================================
# Project: shared-services
#
# These services are shared across ALL applications in the workspace.
# They run independently and can be accessed by any program.
#
# ⚠️  CRITICAL: PORT POLICY - DO NOT VIOLATE ⚠️
# ═══════════════════════════════════════════════════════════════════════════
# ALL external ports MUST be in the range 65000-65099.
# DO NOT use ports outside this range.
# ═══════════════════════════════════════════════════════════════════════════
#
# RAM Budget (Shared Services - 8GB Total):
#   PostgreSQL:       2GB (shared database for all apps)
#   Redis:            1GB (shared cache/sessions)
#   Keycloak:         3GB (shared authentication)
#   Vault:            512MB (shared secrets)
#   Temporal:         1.5GB (workflow engine)
#
# Run:  docker compose -p shared-services up -d
# Stop: docker compose -p shared-services down
#
# Port Allocation (Shared Services):
#   65003 - Vault (shared secrets)
#   65004 - PostgreSQL (shared)
#   65005 - Redis (shared)
#   65006 - Keycloak (shared authentication)
#   65007 - Temporal (shared workflows)
# ==========================================================================

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "20m"
    max-file: "5"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

services:
  # ==========================================================================
  # SHARED DATABASE - PostgreSQL 16 (2GB)
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: shared_postgres
    hostname: postgres
    environment:
      POSTGRES_DB: shared
      POSTGRES_USER: shared_admin
      POSTGRES_PASSWORD: shared_secure_2024
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    command:
      - "postgres"
      - "-c"
      - "max_connections=300"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "max_worker_processes=4"
      - "-c"
      - "max_parallel_workers=4"
      - "-c"
      - "log_statement=mod"
      - "-c"
      - "log_min_duration_statement=500"
    ports:
      - "65004:5432"
    volumes:
      - shared_postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    deploy:
      resources:
        limits:
          memory: 2048M
        reservations:
          memory: 1024M
    networks:
      - shared-network
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-defaults
      test: [ "CMD-SHELL", "pg_isready -U shared_admin -d shared" ]

  # ==========================================================================
  # SHARED CACHE - Redis 7 (1GB)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: shared_redis
    hostname: redis
    command:
      - "redis-server"
      - "--appendonly"
      - "yes"
      - "--appendfsync"
      - "everysec"
      - "--maxmemory"
      - "800mb"
      - "--maxmemory-policy"
      - "allkeys-lru"
      - "--tcp-keepalive"
      - "300"
      - "--databases"
      - "16"
      - "--save"
      - "900 1"
      - "--save"
      - "300 10"
      - "--loglevel"
      - "notice"
    ports:
      - "65005:6379"
    volumes:
      - shared_redis_data:/data
    deploy:
      resources:
        limits:
          memory: 1024M
        reservations:
          memory: 512M
    networks:
      - shared-network
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-defaults
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s

  # ==========================================================================
  # SHARED AUTHENTICATION - Keycloak 24 (3GB)
  # ==========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: shared_keycloak
    hostname: keycloak
    command:
      - "start-dev"
      - "--http-enabled=true"
      - "--http-port=8080"
      - "--hostname-strict=false"
      - "--health-enabled=true"
      - "--metrics-enabled=true"
      - "--import-realm"
      - "--cache=local"
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: shared_admin
      KC_DB_PASSWORD: shared_secure_2024
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: adminpassword123
      KC_LOG_LEVEL: INFO
      # JVM settings for 3GB allocation
      JAVA_OPTS_APPEND: "-Xms1024m -Xmx2560m -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=384m -Djava.net.preferIPv4Stack=true -Djboss.as.management.blocking.timeout=900"
    ports:
      - "65006:8080"
    volumes:
      - shared_keycloak_data:/opt/keycloak/data
      - ../keycloak/realms:/opt/keycloak/data/import:ro
    deploy:
      resources:
        limits:
          memory: 3072M
        reservations:
          memory: 1536M
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - shared-network
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-defaults
      test: [ "CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080" ]
      start_period: 120s
      interval: 30s
      timeout: 15s
      retries: 5

  # ==========================================================================
  # SHARED SECRETS - HashiCorp Vault (512MB)
  # ==========================================================================
  vault:
    image: hashicorp/vault:1.15
    container_name: shared_vault
    hostname: vault
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: devtoken
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://127.0.0.1:8200
    ports:
      - "65003:8200"
    volumes:
      - shared_vault_data:/vault/data
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - shared-network
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-defaults
      test: [ "CMD", "vault", "status" ]

  # ==========================================================================
  # SHARED WORKFLOWS - Temporal (1.5GB)
  # ==========================================================================
  temporal:
    image: temporalio/auto-setup:1.23
    container_name: shared_temporal
    hostname: temporal
    environment:
      DB: postgresql
      DB_PORT: 5432
      POSTGRES_USER: shared_admin
      POSTGRES_PWD: shared_secure_2024
      POSTGRES_SEEDS: postgres
      DYNAMIC_CONFIG_FILE_PATH: /etc/temporal/config/dynamicconfig.yaml
    ports:
      - "65007:7233"
    volumes:
      - shared_temporal_data:/etc/temporal/config
    deploy:
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 768M
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - shared-network
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-defaults
      test: [ "CMD", "tctl", "--address", "temporal:7233", "cluster", "health" ]
      start_period: 60s

# ==========================================================================
# SHARED NETWORK - All programs connect to this
# ==========================================================================
networks:
  shared-network:
    name: shared_services_network
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ==========================================================================
# PERSISTENT VOLUMES
# ==========================================================================
volumes:
  shared_postgres_data:
    driver: local
  shared_redis_data:
    driver: local
  shared_keycloak_data:
    driver: local
  shared_vault_data:
    driver: local
  shared_temporal_data:
    driver: local
