# ==========================================================================
# DJANGO API - Gateway (1.5GB)
# ==========================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: django-api-config
  namespace: agentvoicebox
data:
  # Django Core
  DJANGO_SETTINGS_MODULE: "config.settings.development" # Use dev module but override with prod settings
  DEBUG: "False" # PRODUCTION HARDENING
  # Strict allowed hosts for local cluster & domains
  DJANGO_ALLOWED_HOSTS: "localhost,127.0.0.1,django-api,django-api.agentvoicebox,django-api.agentvoicebox.svc,django-api.agentvoicebox.svc.cluster.local,.agentvoicebox.com,.somatech.dev"
  VOICE_AGENT_BASE_URL: "http://localhost:65020"
  VOICE_AGENT_WS_BASE_URL: "ws://localhost:65020"
  # Database (Isolated)
  DB_HOST: "postgres.agentvoicebox.svc.cluster.local"
  DB_PORT: "5432"
  DB_NAME: "agentvoicebox"
  DB_USER: "avb_admin"
  DB_CONN_MAX_AGE: "60"
  # Redis (Isolated)
  REDIS_URL: "redis://redis.agentvoicebox.svc.cluster.local:6379/0"
  REDIS_CACHE_DB: "1"
  REDIS_SESSION_DB: "2"
  REDIS_CHANNEL_DB: "3"
  REDIS_MAX_CONNECTIONS: "200"
  REDIS_SOCKET_TIMEOUT: "5.0"
  REDIS_SOCKET_CONNECT_TIMEOUT: "5.0"
  REDIS_RETRY_ON_TIMEOUT: "true"
  REDIS_HEALTH_CHECK_INTERVAL: "30"
  # Keycloak (Isolated)
  KEYCLOAK_URL: "http://keycloak.agentvoicebox.svc.cluster.local:8080"
  KEYCLOAK_REALM: "agentvoicebox"
  KEYCLOAK_CLIENT_ID: "agentvoicebox-api"
  # CORS (allow frontend)
  CORS_ALLOW_ALL_ORIGINS: "false"
  CORS_ALLOWED_ORIGINS: "http://localhost:65027,http://localhost:5173,http://localhost:3000,http://localhost:65020,http://localhost:65016" # 65xxx ports
  CORS_ALLOW_CREDENTIALS: "true"
  # Rate Limiting
  RATE_LIMIT_DEFAULT: "60"
  RATE_LIMIT_API_KEY: "120"
  RATE_LIMIT_ADMIN: "300"
  REALTIME_REQUESTS_PER_MINUTE: "100"
  REALTIME_TOKENS_PER_MINUTE: "10000"
  REALTIME_RATE_LIMIT_WINDOW_SECONDS: "60"
  # Observability
  LOG_LEVEL: "DEBUG"
  LOG_FORMAT: "console"
  PROMETHEUS_ENABLED: "true"
  # OPA (disabled for local dev)
  OPA_ENABLED: "false"
  OPA_URL: "http://localhost:8181"
  OPA_DECISION_PATH: "/v1/data/agentvoicebox/allow"
  OPA_TIMEOUT_SECONDS: "3"
  # Kafka (disabled for local dev)
  KAFKA_ENABLED: "false"
  KAFKA_BOOTSTRAP_SERVERS: "localhost:9092"
  KAFKA_CONSUMER_GROUP: "agentvoicebox-backend"
  KAFKA_SECURITY_PROTOCOL: "PLAINTEXT"
  # Vault (disabled)
  VAULT_FAIL_FAST: "false"
  VAULT_ADDR: ""
  VAULT_TOKEN: ""
  VAULT_MOUNT_POINT: "secret"
  # LLM (defaults)
  LLM_DEFAULT_PROVIDER: "groq"
  LLM_DEFAULT_MODEL: "llama-3.1-70b-versatile"
  LLM_MAX_TOKENS: "1024"
  LLM_TEMPERATURE: "0.7"
  LLM_CIRCUIT_BREAKER_THRESHOLD: "5"
  LLM_CIRCUIT_BREAKER_TIMEOUT: "30"
  LLM_MAX_HISTORY_ITEMS: "40"
  LLM_PROVIDER_PRIORITY: "groq,openai,ollama"
  GROQ_API_BASE: "https://api.groq.com/openai/v1"
  OPENAI_API_BASE: "https://api.openai.com/v1"
  OLLAMA_BASE_URL: "http://localhost:11434"
  # Worker Streams
  LLM_STREAM_REQUESTS: "llm:requests"
  LLM_GROUP_WORKERS: "llm-workers"
  LLM_RESPONSE_CHANNEL: "llm:response"
  STT_STREAM_AUDIO: "audio:stt"
  STT_GROUP_WORKERS: "stt-workers"
  STT_CHANNEL_TRANSCRIPTION: "transcription"
  TTS_STREAM_REQUESTS: "tts:requests"
  TTS_GROUP_WORKERS: "tts-workers"
  TTS_CHANNEL_TTS: "tts"
  TTS_CHANNEL_AUDIO_OUT: "audio:out"
  # Temporal (disabled)
  TEMPORAL_HOST: "localhost:7233"
  TEMPORAL_NAMESPACE: "agentvoicebox"
  TEMPORAL_TASK_QUEUE: "default"
  # STT Configuration
  STT_MODEL: "base"
  STT_DEVICE: "auto"
  STT_COMPUTE_TYPE: "float16"
  STT_BATCH_SIZE: "4"
  STT_SAMPLE_RATE: "16000"
  # TTS Configuration
  TTS_MODEL_DIR: "/app/cache/kokoro"
  TTS_MODEL_FILE: "kokoro-v1.0.onnx"
  TTS_VOICES_FILE: "voices-v1.0.bin"
  TTS_DEFAULT_VOICE: "am_onyx"
  TTS_DEFAULT_SPEED: "1.1"
  TTS_CHUNK_SIZE: "24000"
  # Billing disabled for local
  LAGO_API_URL: ""
  LAGO_API_KEY: ""
  LAGO_WEBHOOK_SECRET: ""
---
apiVersion: v1
kind: Secret
metadata:
  name: django-api-secret
  namespace: agentvoicebox
type: Opaque
stringData:
  DJANGO_SECRET_KEY: "dev-secret-key-for-local-development-only-at-least-50-characters"
  DB_PASSWORD: "shared_secure_2024"
  KEYCLOAK_CLIENT_SECRET: "dev-secret-12345"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: django-api
  namespace: agentvoicebox
  labels:
    app: django-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: django-api
  template:
    metadata:
      labels:
        app: django-api
    spec:
      containers:
        - name: django-api
          image: avb-django-api:latest
          imagePullPolicy: Never  # Use local image from Tilt
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: django-api-config
            - secretRef:
                name: django-api-secret
          resources:
            limits:
              memory: "1Gi" # Keep limit high for bursts
              cpu: "1000m"
            requests:
              memory: "256Mi" # Reduce request to fit 2 replicas
              cpu: "100m"
          readinessProbe:
            httpGet:
              path: /health/
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health/
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: django-api
  namespace: agentvoicebox
spec:
  selector:
    app: django-api
  ports:
    - port: 8000
      targetPort: 8000
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: django-api-external
  namespace: agentvoicebox
spec:
  selector:
    app: django-api
  ports:
    - port: 8000
      targetPort: 8000
      nodePort: 30020
  type: NodePort
