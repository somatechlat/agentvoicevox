x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

services:
  temporal:
    image: temporalio/auto-setup:1.24.2
    container_name: agentvoicebox_temporal
    hostname: temporal
    env_file:
      - ../settings.docker.env
    environment:
      - DB=${TEMPORAL_DB}
      - DB_PORT=${TEMPORAL_DB_PORT}
      - POSTGRES_USER=${TEMPORAL_POSTGRES_USER}
      - POSTGRES_PWD=${TEMPORAL_POSTGRES_PWD}
      - POSTGRES_SEEDS=${TEMPORAL_POSTGRES_SEEDS}
      - ENABLE_ES=${TEMPORAL_ENABLE_ES}
      - TEMPORAL_ADDRESS=${TEMPORAL_ADDRESS}
      - SKIP_DEFAULT_NAMESPACE_CREATION=${TEMPORAL_SKIP_DEFAULT_NAMESPACE_CREATION}
    ports:
      - "65001:7233"
    volumes:
      - agentvoicebox_temporal_data:/var/lib/temporal
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - agentvoicebox-network
      - shared-network
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "temporal", "workflow", "list", "--namespace", "default"]
      start_period: 120s

  temporal-ui:
    image: temporalio/ui:2.26.2
    container_name: agentvoicebox_temporal_ui
    hostname: temporal-ui
    env_file:
      - ../settings.docker.env
    environment:
      - TEMPORAL_ADDRESS=${TEMPORAL_ADDRESS}
    ports:
      - "65002:8080"
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      - temporal
    networks:
      - agentvoicebox-network
    logging: *default-logging
    restart: unless-stopped

  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: agentvoicebox_backend
    hostname: backend
    env_file:
      - ../settings.docker.env
    ports:
      - "65000:8000"
    volumes:
      - agentvoicebox_backend_static:/app/staticfiles
      - agentvoicebox_backend_media:/app/media
      - agentvoicebox_backend_logs:/app/logs
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - agentvoicebox-network
      - shared-network
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      start_period: 60s

  portal-frontend:
    build:
      context: ../portal-frontend
      dockerfile: Dockerfile
    container_name: agentvoicebox_portal_frontend
    hostname: portal-frontend
    env_file:
      - ../settings.docker.env
    ports:
      - "65013:3000"
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - agentvoicebox-network
      - shared-network
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      start_period: 60s

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: agentvoicebox_prometheus
    hostname: prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
    ports:
      - "65011:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - agentvoicebox_prometheus_data:/prometheus
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - agentvoicebox-network
    logging: *default-logging
    restart: unless-stopped
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]


networks:
  agentvoicebox-network:
    name: agentvoicebox_network
    driver: bridge
  shared-network:
    name: shared_services_network
    external: true

volumes:
  agentvoicebox_temporal_data:
  agentvoicebox_backend_static:
  agentvoicebox_backend_media:
  agentvoicebox_backend_logs:
  agentvoicebox_prometheus_data:
