# ==========================================================================
# LAGO BILLING - Production Multi-Tenant Cluster (READY TO USE)
# ==========================================================================
# Ports: 63690-63699 (ISOLATED from VoiceBox 65xxx range)
# Memory: ~6GB Total | Multi-tenant | Resilient
#
# Run:  docker compose -p lago up -d
# Stop: docker compose -p lago down
#
# Access:
#   Dashboard: http://localhost:63691
#   API:       http://localhost:63690
# ==========================================================================

x-logging: &logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

x-restart: &restart
  restart: unless-stopped

services:
  # ==========================================================================
  # DATABASE - PostgreSQL 14 (2GB)
  # ==========================================================================
  db:
    image: postgres:14-alpine
    container_name: lago-db
    hostname: db
    environment:
      POSTGRES_DB: lago
      POSTGRES_USER: lago
      POSTGRES_PASSWORD: lago_production_2024
    ports:
      - "63692:5432"
    volumes:
      - lago_postgres_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 2048M
        reservations:
          memory: 512M
    healthcheck:
      test: [ "CMD", "pg_isready", "-U", "lago" ]
      interval: 10s
      timeout: 5s
      retries: 5
    logging: *logging
    <<: *restart

  # ==========================================================================
  # CACHE - Redis 6 (512MB)
  # ==========================================================================
  redis:
    image: redis:6-alpine
    container_name: lago-redis
    hostname: redis
    ports:
      - "63693:6379"
    volumes:
      - lago_redis_data:/data
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    logging: *logging
    <<: *restart

  # ==========================================================================
  # API - Rails Application (1.5GB)
  # ==========================================================================
  api:
    image: getlago/api:v1.39.0
    container_name: lago-api
    hostname: api
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://lago:lago_production_2024@db:5432/lago
      REDIS_URL: redis://redis:6379
      SECRET_KEY_BASE: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      LAGO_API_URL: http://localhost:63690
      LAGO_FRONT_URL: http://localhost:63691
      LAGO_PDF_URL: http://pdf:3000
      LAGO_RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY:-}
      LAGO_ENCRYPTION_PRIMARY_KEY: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8
      LAGO_SIDEKIQ_WEB: "true"
      LAGO_DISABLE_SIGNUP: "false"
    ports:
      - "63690:3000"
    volumes:
      - lago_storage_data:/app/storage
    deploy:
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 512M
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    logging: *logging
    <<: *restart

  # ==========================================================================
  # WORKER - Sidekiq Background Jobs (1GB)
  # ==========================================================================
  worker:
    image: getlago/api:v1.39.0
    container_name: lago-worker
    hostname: worker
    command: [ "bundle", "exec", "sidekiq", "-C", "config/sidekiq.yml" ]
    depends_on:
      api:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://lago:lago_production_2024@db:5432/lago
      REDIS_URL: redis://redis:6379
      SECRET_KEY_BASE: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
      RAILS_ENV: production
      LAGO_RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY:-}
      LAGO_ENCRYPTION_PRIMARY_KEY: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8
    volumes:
      - lago_storage_data:/app/storage
    deploy:
      resources:
        limits:
          memory: 1024M
        reservations:
          memory: 256M
    logging: *logging
    <<: *restart

  # ==========================================================================
  # CLOCK - Scheduled Jobs (256MB)
  # ==========================================================================
  clock:
    image: getlago/api:v1.39.0
    container_name: lago-clock
    hostname: clock
    command: [ "bundle", "exec", "clockwork", "config/clock.rb" ]
    depends_on:
      api:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://lago:lago_production_2024@db:5432/lago
      REDIS_URL: redis://redis:6379
      SECRET_KEY_BASE: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
      RAILS_ENV: production
      LAGO_RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY:-}
      LAGO_ENCRYPTION_PRIMARY_KEY: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    logging: *logging
    <<: *restart

  # ==========================================================================
  # FRONTEND - Dashboard UI (512MB)
  # ==========================================================================
  front:
    image: getlago/front:v1.39.0
    container_name: lago-front
    hostname: front
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_URL: http://api:3000
      APP_ENV: production
      LAGO_DISABLE_SIGNUP: "false"
    ports:
      - "63691:80"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80" ]
      interval: 30s
      timeout: 10s
      retries: 3
    logging: *logging
    <<: *restart

  # ==========================================================================
  # PDF - Invoice PDF Generator (512MB)
  # ==========================================================================
  pdf:
    image: getlago/lago-gotenberg:7
    container_name: lago-pdf
    hostname: pdf
    ports:
      - "63694:3000"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging: *logging
    <<: *restart

networks:
  default:
    name: lago_network
    driver: bridge

volumes:
  lago_postgres_data:
    driver: local
  lago_redis_data:
    driver: local
  lago_storage_data:
    driver: local
