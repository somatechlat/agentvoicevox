<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentVoiceBox | Voice Agent Platform</title>
    
    <!-- Design System -->
    <link rel="stylesheet" href="design-system/somastack-ui.css">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
    <div class="app-container" x-data="voiceBoxApp()" x-init="init()">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">V</div>
                <span class="logo-text">VoiceBox</span>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <button class="nav-item" :class="{ active: currentView === 'dashboard' }" @click="currentView = 'dashboard'">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </button>
                    <button class="nav-item" :class="{ active: currentView === 'voice' }" @click="currentView = 'voice'">
                        <i class="fas fa-microphone"></i>
                        <span>Voice Interface</span>
                    </button>
                    <button class="nav-item" :class="{ active: currentView === 'transcripts' }" @click="currentView = 'transcripts'">
                        <i class="fas fa-file-alt"></i>
                        <span>Transcripts</span>
                    </button>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Configuration</div>
                    <button class="nav-item" :class="{ active: currentView === 'voices' }" @click="currentView = 'voices'">
                        <i class="fas fa-volume-up"></i>
                        <span>Voice Models</span>
                    </button>
                    <button class="nav-item" :class="{ active: currentView === 'providers' }" @click="currentView = 'providers'">
                        <i class="fas fa-plug"></i>
                        <span>Providers</span>
                    </button>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <button class="nav-item" :class="{ active: currentView === 'health' }" @click="currentView = 'health'">
                        <i class="fas fa-heartbeat"></i>
                        <span>Health</span>
                    </button>
                    <button class="nav-item" :class="{ active: currentView === 'logs' }" @click="currentView = 'logs'">
                        <i class="fas fa-terminal"></i>
                        <span>Logs</span>
                    </button>
                    <button class="nav-item" :class="{ active: currentView === 'settings' }" @click="currentView = 'settings'">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="page-title" x-text="getPageTitle()"></h1>
                <div class="flex gap-2">
                    <div class="voice-status">
                        <div class="voice-status-indicator" :class="connectionStatus"></div>
                        <div>
                            <div class="voice-status-text" x-text="getConnectionLabel()"></div>
                            <div class="voice-status-detail" x-text="wsEndpoint"></div>
                        </div>
                    </div>
                    <button class="header-btn" @click="toggleTheme()">
                        <i class="fas" :class="isDark ? 'fa-sun' : 'fa-moon'"></i>
                    </button>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard View -->
                <template x-if="currentView === 'dashboard'">
                    <div>
                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <span class="stat-label">Active Sessions</span>
                                    <div class="stat-icon"><i class="fas fa-headset"></i></div>
                                </div>
                                <div class="stat-value" x-text="stats.activeSessions"></div>
                                <div class="stat-change positive">
                                    <i class="fas fa-check"></i>
                                    <span>All connected</span>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-header">
                                    <span class="stat-label">Total Conversations</span>
                                    <div class="stat-icon"><i class="fas fa-comments"></i></div>
                                </div>
                                <div class="stat-value" x-text="stats.totalConversations.toLocaleString()"></div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+45 today</span>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-header">
                                    <span class="stat-label">Avg Response Time</span>
                                    <div class="stat-icon"><i class="fas fa-bolt"></i></div>
                                </div>
                                <div class="stat-value" x-text="stats.avgResponseTime + 'ms'"></div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>-12ms from avg</span>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-header">
                                    <span class="stat-label">Audio Processed</span>
                                    <div class="stat-icon"><i class="fas fa-wave-square"></i></div>
                                </div>
                                <div class="stat-value" x-text="stats.audioProcessed"></div>
                                <div class="stat-change positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+2.3h today</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Voice Interface Preview & Provider Status -->
                        <div class="grid grid-cols-2 gap-6">
                            <!-- Quick Voice Test -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Quick Voice Test</span>
                                    <span class="badge" :class="connectionStatus === 'connected' ? 'badge-success' : 'badge-default'">
                                        <span class="status-dot" :class="connectionStatus === 'connected' ? 'online' : 'offline'"></span>
                                        <span x-text="connectionStatus === 'connected' ? 'Ready' : 'Disconnected'"></span>
                                    </span>
                                </div>
                                <div class="card-body">
                                    <!-- Waveform -->
                                    <div class="waveform-container mb-4">
                                        <template x-if="!isRecording && !isPlaying">
                                            <div class="waveform-placeholder">
                                                <i class="fas fa-microphone"></i>
                                                <span>Click the mic button to start</span>
                                            </div>
                                        </template>
                                        <template x-if="isRecording || isPlaying">
                                            <div class="waveform-bars">
                                                <template x-for="i in 32" :key="i">
                                                    <div class="waveform-bar" :class="{ active: isRecording || isPlaying }" 
                                                         :style="'height: ' + (20 + Math.random() * 60) + 'px'"></div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <!-- Controls -->
                                    <div class="voice-controls">
                                        <button class="voice-btn voice-btn-secondary" @click="toggleMute()" :disabled="!isConnected">
                                            <i class="fas" :class="isMuted ? 'fa-volume-mute' : 'fa-volume-up'"></i>
                                        </button>
                                        <button class="voice-btn voice-btn-primary" :class="{ active: isRecording }" 
                                                @click="toggleRecording()" :disabled="!isConnected">
                                            <i class="fas" :class="isRecording ? 'fa-stop' : 'fa-microphone'"></i>
                                        </button>
                                        <button class="voice-btn voice-btn-secondary" @click="interrupt()" :disabled="!isPlaying">
                                            <i class="fas fa-hand-paper"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Provider Status -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Provider Status</span>
                                    <button class="btn btn-ghost btn-sm" @click="refreshProviders()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <template x-for="provider in providers" :key="provider.name">
                                        <div class="provider-card mb-4">
                                            <div class="provider-icon">
                                                <i :class="provider.icon"></i>
                                            </div>
                                            <div class="provider-info">
                                                <div class="provider-name" x-text="provider.name"></div>
                                                <div class="provider-detail" x-text="provider.model"></div>
                                            </div>
                                            <div class="provider-status">
                                                <span class="badge" :class="'badge-' + provider.statusType">
                                                    <span class="status-dot" :class="provider.status"></span>
                                                    <span x-text="provider.statusLabel"></span>
                                                </span>
                                                <span class="text-xs text-muted" x-text="provider.latency + 'ms'"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Transcripts -->
                        <div class="card mt-6">
                            <div class="card-header">
                                <span class="card-title">Recent Transcripts</span>
                                <button class="btn btn-ghost btn-sm" @click="currentView = 'transcripts'">
                                    View All
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="transcription-body" style="max-height: 200px;">
                                    <template x-for="entry in recentTranscripts" :key="entry.id">
                                        <div class="transcription-entry" :class="entry.role">
                                            <div class="transcription-entry-header">
                                                <span class="transcription-entry-role" x-text="entry.role"></span>
                                                <span class="transcription-entry-time" x-text="entry.time"></span>
                                            </div>
                                            <div class="transcription-entry-text" x-text="entry.text"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Voice Interface View -->
                <template x-if="currentView === 'voice'">
                    <div>
                        <div class="grid grid-cols-3 gap-6">
                            <!-- Main Voice Panel -->
                            <div class="card" style="grid-column: span 2;">
                                <div class="card-header">
                                    <span class="card-title">Voice Interface</span>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary btn-sm" @click="connect()" :disabled="isConnected">
                                            <i class="fas fa-plug"></i>
                                            Connect
                                        </button>
                                        <button class="btn btn-danger btn-sm" @click="disconnect()" :disabled="!isConnected">
                                            <i class="fas fa-times"></i>
                                            Disconnect
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Large Waveform -->
                                    <div class="waveform-container mb-6" style="height: 160px;">
                                        <template x-if="!isRecording && !isPlaying">
                                            <div class="waveform-placeholder">
                                                <i class="fas fa-microphone" style="font-size: 32px;"></i>
                                                <span>Press and hold to talk, or click to toggle</span>
                                            </div>
                                        </template>
                                        <template x-if="isRecording">
                                            <div class="waveform-bars">
                                                <template x-for="i in 48" :key="i">
                                                    <div class="waveform-bar active" :style="'height: ' + (20 + Math.random() * 100) + 'px'"></div>
                                                </template>
                                            </div>
                                        </template>
                                        <template x-if="isPlaying && !isRecording">
                                            <div class="waveform-bars">
                                                <template x-for="i in 48" :key="i">
                                                    <div class="waveform-bar" style="background: var(--soma-info);" 
                                                         :style="'height: ' + (20 + Math.random() * 80) + 'px; animation-delay: ' + (i * 0.02) + 's'"></div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <!-- Voice Controls -->
                                    <div class="voice-controls mb-6">
                                        <button class="voice-btn voice-btn-secondary" @click="toggleMute()">
                                            <i class="fas" :class="isMuted ? 'fa-volume-mute' : 'fa-volume-up'"></i>
                                        </button>
                                        <button class="voice-btn voice-btn-primary" :class="{ active: isRecording }" 
                                                @click="toggleRecording()" @mousedown="startPTT()" @mouseup="stopPTT()" @mouseleave="stopPTT()">
                                            <i class="fas" :class="isRecording ? 'fa-stop' : 'fa-microphone'"></i>
                                        </button>
                                        <button class="voice-btn voice-btn-secondary" @click="interrupt()">
                                            <i class="fas fa-hand-paper"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- TTS Progress -->
                                    <div class="tts-progress" x-show="isPlaying">
                                        <div class="tts-progress-header">
                                            <span class="tts-progress-label">Playing response...</span>
                                            <span class="tts-progress-time" x-text="ttsProgress.current + ' / ' + ttsProgress.total"></span>
                                        </div>
                                        <div class="tts-progress-bar">
                                            <div class="tts-progress-fill" :style="'width: ' + ttsProgress.percent + '%'"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Interim Transcription -->
                                    <div class="transcription-container mt-4" x-show="interimText">
                                        <div class="transcription-body">
                                            <div class="transcription-interim" x-text="interimText"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Settings Panel -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Voice Settings</span>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Voice Model</label>
                                        <select class="form-input form-select" x-model="voiceSettings.voice">
                                            <template x-for="voice in availableVoices" :key="voice.id">
                                                <option :value="voice.id" x-text="voice.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                    
                                    <div class="voice-setting">
                                        <div class="voice-setting-label">
                                            <span class="voice-setting-name">Speed</span>
                                            <span class="voice-setting-value" x-text="voiceSettings.speed.toFixed(2) + 'x'"></span>
                                        </div>
                                        <input type="range" class="voice-slider" min="0.5" max="2.0" step="0.05" x-model="voiceSettings.speed">
                                    </div>
                                    
                                    <div class="voice-setting">
                                        <div class="voice-setting-label">
                                            <span class="voice-setting-name">Pitch</span>
                                            <span class="voice-setting-value" x-text="voiceSettings.pitch.toFixed(2)"></span>
                                        </div>
                                        <input type="range" class="voice-slider" min="0.5" max="1.5" step="0.05" x-model="voiceSettings.pitch">
                                    </div>
                                    
                                    <div class="voice-setting">
                                        <div class="voice-setting-label">
                                            <span class="voice-setting-name">Volume</span>
                                            <span class="voice-setting-value" x-text="Math.round(voiceSettings.volume * 100) + '%'"></span>
                                        </div>
                                        <input type="range" class="voice-slider" min="0" max="1" step="0.05" x-model="voiceSettings.volume">
                                    </div>
                                    
                                    <hr style="border: none; border-top: 1px solid var(--soma-border-subtle); margin: var(--soma-space-4) 0;">
                                    
                                    <div class="form-group">
                                        <label class="form-label">Input Mode</label>
                                        <div class="flex gap-2">
                                            <button class="btn btn-sm" :class="voiceSettings.inputMode === 'ptt' ? 'btn-primary' : 'btn-secondary'" 
                                                    @click="voiceSettings.inputMode = 'ptt'">
                                                Push-to-Talk
                                            </button>
                                            <button class="btn btn-sm" :class="voiceSettings.inputMode === 'vad' ? 'btn-primary' : 'btn-secondary'"
                                                    @click="voiceSettings.inputMode = 'vad'">
                                                Voice Activity
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary w-full mt-4" @click="applySettings()">
                                        <i class="fas fa-check"></i>
                                        Apply Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conversation History -->
                        <div class="card mt-6">
                            <div class="card-header">
                                <span class="card-title">Conversation</span>
                                <button class="btn btn-ghost btn-sm" @click="clearConversation()">
                                    <i class="fas fa-trash"></i>
                                    Clear
                                </button>
                            </div>
                            <div class="transcription-body">
                                <template x-for="entry in conversation" :key="entry.id">
                                    <div class="transcription-entry" :class="entry.role">
                                        <div class="transcription-entry-header">
                                            <span class="transcription-entry-role" x-text="entry.role"></span>
                                            <span class="transcription-entry-time" x-text="entry.time"></span>
                                        </div>
                                        <div class="transcription-entry-text" x-text="entry.text"></div>
                                    </div>
                                </template>
                                <template x-if="conversation.length === 0">
                                    <div class="text-center text-muted" style="padding: var(--soma-space-8);">
                                        <i class="fas fa-comments" style="font-size: 32px; opacity: 0.3; margin-bottom: var(--soma-space-2);"></i>
                                        <p>No conversation yet. Start talking!</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Providers View -->
                <template x-if="currentView === 'providers'">
                    <div>
                        <div class="grid grid-cols-2 gap-6">
                            <!-- STT Provider -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Speech-to-Text (STT)</span>
                                    <span class="badge badge-success">
                                        <span class="status-dot online"></span>
                                        Active
                                    </span>
                                </div>
                                <div class="card-body">
                                    <div class="provider-card mb-4">
                                        <div class="provider-icon" style="background: var(--accent-subtle); color: var(--accent);">
                                            <i class="fas fa-microphone-alt"></i>
                                        </div>
                                        <div class="provider-info">
                                            <div class="provider-name">Faster-Whisper</div>
                                            <div class="provider-detail">tiny.en model • CPU/int8</div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <div class="text-muted mb-1">Avg Latency</div>
                                            <div class="font-semibold">245ms</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Accuracy</div>
                                            <div class="font-semibold">94.2%</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Language</div>
                                            <div class="font-semibold">English</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Sample Rate</div>
                                            <div class="font-semibold">16kHz</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TTS Provider -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Text-to-Speech (TTS)</span>
                                    <span class="badge badge-success">
                                        <span class="status-dot online"></span>
                                        Active
                                    </span>
                                </div>
                                <div class="card-body">
                                    <div class="provider-card mb-4">
                                        <div class="provider-icon" style="background: var(--soma-info-bg); color: var(--soma-info);">
                                            <i class="fas fa-volume-up"></i>
                                        </div>
                                        <div class="provider-info">
                                            <div class="provider-name">Kokoro TTS</div>
                                            <div class="provider-detail">af_heart voice • 24kHz</div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <div class="text-muted mb-1">Avg Latency</div>
                                            <div class="font-semibold">180ms</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Quality</div>
                                            <div class="font-semibold">High</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Output Format</div>
                                            <div class="font-semibold">PCM 24kHz</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Streaming</div>
                                            <div class="font-semibold">Enabled</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- LLM Provider -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Language Model (LLM)</span>
                                    <span class="badge badge-success">
                                        <span class="status-dot online"></span>
                                        Active
                                    </span>
                                </div>
                                <div class="card-body">
                                    <div class="provider-card mb-4">
                                        <div class="provider-icon" style="background: var(--soma-success-bg); color: var(--soma-success);">
                                            <i class="fas fa-brain"></i>
                                        </div>
                                        <div class="provider-info">
                                            <div class="provider-name">Groq API</div>
                                            <div class="provider-detail">llama-3.1-70b-versatile</div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <div class="text-muted mb-1">Avg Latency</div>
                                            <div class="font-semibold">320ms</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Tokens/sec</div>
                                            <div class="font-semibold">~150</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Context</div>
                                            <div class="font-semibold">128K tokens</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Streaming</div>
                                            <div class="font-semibold">Enabled</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- WebSocket Server -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">WebSocket Server</span>
                                    <span class="badge badge-success">
                                        <span class="status-dot online"></span>
                                        Running
                                    </span>
                                </div>
                                <div class="card-body">
                                    <div class="provider-card mb-4">
                                        <div class="provider-icon" style="background: var(--soma-warning-bg); color: var(--soma-warning);">
                                            <i class="fas fa-server"></i>
                                        </div>
                                        <div class="provider-info">
                                            <div class="provider-name">Realtime API</div>
                                            <div class="provider-detail">OpenAI-compatible protocol</div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <div class="text-muted mb-1">Endpoint</div>
                                            <div class="font-semibold">ws://localhost:60200</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Connections</div>
                                            <div class="font-semibold">3 active</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Protocol</div>
                                            <div class="font-semibold">v1/realtime</div>
                                        </div>
                                        <div>
                                            <div class="text-muted mb-1">Auth</div>
                                            <div class="font-semibold">Bearer Token</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                
                <!-- Health View -->
                <template x-if="currentView === 'health'">
                    <div>
                        <div class="grid grid-cols-2 gap-6">
                            <template x-for="service in systemHealth" :key="service.name">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="flex items-center gap-4 mb-4">
                                            <div class="stat-icon">
                                                <i :class="service.icon"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold" x-text="service.name"></h3>
                                                <span class="badge" :class="'badge-' + service.statusType">
                                                    <span class="status-dot" :class="service.status"></span>
                                                    <span x-text="service.statusLabel"></span>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <div class="text-muted">Latency</div>
                                                <div class="font-medium" x-text="service.latency + 'ms'"></div>
                                            </div>
                                            <div>
                                                <div class="text-muted">Uptime</div>
                                                <div class="font-medium" x-text="service.uptime || '99.9%'"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
                
                <!-- Logs View -->
                <template x-if="currentView === 'logs'">
                    <div>
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">System Logs</span>
                                <div class="flex gap-2">
                                    <button class="btn btn-ghost btn-sm" @click="clearLogs()">
                                        <i class="fas fa-trash"></i>
                                        Clear
                                    </button>
                                    <button class="btn btn-secondary btn-sm" @click="refreshLogs()">
                                        <i class="fas fa-sync-alt"></i>
                                        Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="log-container" style="max-height: 500px;">
                                <template x-for="log in logs" :key="log.id">
                                    <div class="log-entry" :class="log.level">
                                        <span class="log-time" x-text="log.time"></span>
                                        <span class="log-message" x-text="log.message"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </main>
    </div>

    <script>
        function voiceBoxApp() {
            return {
                // State
                currentView: 'dashboard',
                isDark: false,
                
                // Connection
                ws: null,
                isConnected: false,
                connectionStatus: 'offline',
                wsEndpoint: 'ws://localhost:60200',
                clientSecret: null,
                sessionId: null,
                
                // Voice State
                isRecording: false,
                isPlaying: false,
                isMuted: false,
                interimText: '',
                audioStream: null,
                mediaRecorder: null,
                currentAudio: null,
                
                // TTS Progress
                ttsProgress: {
                    current: '0:00',
                    total: '0:00',
                    percent: 0
                },
                
                // Voice Settings
                voiceSettings: {
                    voice: 'af_heart',
                    speed: 1.0,
                    pitch: 1.0,
                    volume: 0.8,
                    inputMode: 'ptt'
                },
                
                // Available Voices
                availableVoices: [
                    { id: 'af_heart', name: 'Heart (Female)' },
                    { id: 'af_bella', name: 'Bella (Female)' },
                    { id: 'am_adam', name: 'Adam (Male)' },
                    { id: 'am_michael', name: 'Michael (Male)' },
                    { id: 'bf_emma', name: 'Emma (British Female)' },
                    { id: 'bm_george', name: 'George (British Male)' }
                ],
                
                // Stats
                stats: {
                    activeSessions: 3,
                    totalConversations: 1247,
                    avgResponseTime: 245,
                    audioProcessed: '12.4h'
                },
                
                // Providers
                providers: [
                    { name: 'STT (Whisper)', icon: 'fas fa-microphone-alt', model: 'tiny.en', status: 'online', statusType: 'success', statusLabel: 'Healthy', latency: 245 },
                    { name: 'TTS (Kokoro)', icon: 'fas fa-volume-up', model: 'af_heart', status: 'online', statusType: 'success', statusLabel: 'Healthy', latency: 180 },
                    { name: 'LLM (Groq)', icon: 'fas fa-brain', model: 'llama-3.1-70b', status: 'online', statusType: 'success', statusLabel: 'Healthy', latency: 320 }
                ],
                
                // System Health
                systemHealth: [
                    { name: 'Voice Agent', icon: 'fas fa-headset', status: 'online', statusType: 'success', statusLabel: 'Healthy', latency: 12, uptime: '99.99%' },
                    { name: 'WebSocket Server', icon: 'fas fa-server', status: 'online', statusType: 'success', statusLabel: 'Healthy', latency: 3, uptime: '99.99%' },
                    { name: 'STT Worker', icon: 'fas fa-microphone', status: 'online', statusType: 'success', statusLabel: 'Healthy', latency: 245, uptime: '99.95%' },
                    { name: 'TTS Worker', icon: 'fas fa-volume-up', status: 'online', statusType: 'success', statusLabel: 'Healthy', latency: 180, uptime: '99.99%' }
                ],
                
                // Conversation
                conversation: [],
                
                // Recent Transcripts
                recentTranscripts: [
                    { id: 't1', role: 'user', text: 'What is the weather like today?', time: '2 min ago' },
                    { id: 't2', role: 'assistant', text: 'I don\'t have access to real-time weather data, but I can help you find weather information for your location.', time: '2 min ago' },
                    { id: 't3', role: 'user', text: 'Can you tell me a joke?', time: '5 min ago' },
                    { id: 't4', role: 'assistant', text: 'Why don\'t scientists trust atoms? Because they make up everything!', time: '5 min ago' }
                ],
                
                // Logs
                logs: [
                    { id: 'l1', time: '14:32:15', level: 'info', message: 'WebSocket connection established' },
                    { id: 'l2', time: '14:32:16', level: 'success', message: 'STT worker initialized (Faster-Whisper tiny.en)' },
                    { id: 'l3', time: '14:32:16', level: 'success', message: 'TTS worker initialized (Kokoro af_heart)' },
                    { id: 'l4', time: '14:32:17', level: 'info', message: 'Session created: sess_abc123' },
                    { id: 'l5', time: '14:33:45', level: 'info', message: 'Audio input received (2.3s)' },
                    { id: 'l6', time: '14:33:46', level: 'info', message: 'Transcription complete: "What is the weather like today?"' },
                    { id: 'l7', time: '14:33:47', level: 'info', message: 'LLM response generated (320ms)' },
                    { id: 'l8', time: '14:33:48', level: 'info', message: 'TTS audio generated (180ms)' }
                ],
                
                // Methods
                getPageTitle() {
                    const titles = {
                        dashboard: 'Dashboard',
                        voice: 'Voice Interface',
                        transcripts: 'Transcripts',
                        voices: 'Voice Models',
                        providers: 'Providers',
                        health: 'System Health',
                        logs: 'System Logs',
                        settings: 'Settings'
                    };
                    return titles[this.currentView] || 'Dashboard';
                },
                
                getConnectionLabel() {
                    const labels = {
                        offline: 'Disconnected',
                        connecting: 'Connecting...',
                        connected: 'Connected',
                        listening: 'Listening',
                        speaking: 'Speaking'
                    };
                    return labels[this.connectionStatus] || 'Unknown';
                },
                
                toggleTheme() {
                    this.isDark = !this.isDark;
                    document.documentElement.setAttribute('data-theme', this.isDark ? 'dark' : 'light');
                    localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
                },
                
                async getClientSecret() {
                    try {
                        const response = await fetch(`http://localhost:60200/v1/realtime/client_secrets`, {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer sk-local-token',
                                'Content-Type': 'application/json'
                            },
                            body: '{}'
                        });
                        const data = await response.json();
                        this.clientSecret = data.value;
                        this.sessionId = data.session?.id;
                        return data.value;
                    } catch (error) {
                        console.error('Failed to get client secret:', error);
                        this.addLog('error', 'Failed to get client secret: ' + error.message);
                        return null;
                    }
                },
                
                async connect() {
                    this.connectionStatus = 'connecting';
                    
                    if (!this.clientSecret) {
                        await this.getClientSecret();
                    }
                    
                    if (!this.clientSecret) {
                        this.connectionStatus = 'offline';
                        return;
                    }
                    
                    try {
                        this.ws = new WebSocket(`${this.wsEndpoint}/v1/realtime?access_token=${encodeURIComponent(this.clientSecret)}`);
                        
                        this.ws.onopen = () => {
                            this.isConnected = true;
                            this.connectionStatus = 'connected';
                            this.addLog('success', 'WebSocket connection established');
                        };
                        
                        this.ws.onclose = () => {
                            this.isConnected = false;
                            this.connectionStatus = 'offline';
                            this.addLog('info', 'WebSocket connection closed');
                        };
                        
                        this.ws.onmessage = (event) => {
                            this.handleMessage(JSON.parse(event.data));
                        };
                        
                        this.ws.onerror = (error) => {
                            console.error('WebSocket error:', error);
                            this.addLog('error', 'WebSocket error');
                        };
                    } catch (error) {
                        console.error('Connection failed:', error);
                        this.connectionStatus = 'offline';
                        this.addLog('error', 'Connection failed: ' + error.message);
                    }
                },
                
                disconnect() {
                    if (this.ws) {
                        this.ws.close();
                        this.ws = null;
                    }
                    this.isConnected = false;
                    this.connectionStatus = 'offline';
                },
                
                handleMessage(message) {
                    const type = message.type;
                    if (!type) return;
                    
                    this.addLog('info', `Event: ${type}`);
                    
                    if (type === 'response.audio.delta' && message.delta) {
                        this.playAudio(message.delta);
                    } else if (type === 'input_audio_buffer.speech_started') {
                        this.connectionStatus = 'listening';
                    } else if (type === 'input_audio_buffer.speech_stopped') {
                        this.connectionStatus = 'connected';
                    } else if (type === 'response.audio.done') {
                        this.isPlaying = false;
                        this.connectionStatus = 'connected';
                    }
                },
                
                playAudio(base64Audio) {
                    try {
                        this.isPlaying = true;
                        this.connectionStatus = 'speaking';
                        
                        const binary = atob(base64Audio);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) {
                            bytes[i] = binary.charCodeAt(i);
                        }
                        
                        const blob = new Blob([bytes], { type: 'audio/wav' });
                        const url = URL.createObjectURL(blob);
                        
                        if (this.currentAudio) {
                            this.currentAudio.pause();
                        }
                        
                        this.currentAudio = new Audio(url);
                        this.currentAudio.volume = this.voiceSettings.volume;
                        this.currentAudio.play().catch(() => {});
                        
                        this.currentAudio.onended = () => {
                            this.isPlaying = false;
                            this.connectionStatus = 'connected';
                        };
                    } catch (error) {
                        console.error('Audio playback error:', error);
                        this.addLog('error', 'Audio playback error');
                    }
                },
                
                async toggleRecording() {
                    if (this.isRecording) {
                        this.stopRecording();
                    } else {
                        await this.startRecording();
                    }
                },
                
                async startRecording() {
                    if (this.isRecording || !this.isConnected) return;
                    
                    try {
                        this.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.mediaRecorder = new MediaRecorder(this.audioStream);
                        
                        this.mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0 && this.ws && this.ws.readyState === WebSocket.OPEN) {
                                const reader = new FileReader();
                                reader.onload = () => {
                                    const base64 = btoa(String.fromCharCode(...new Uint8Array(reader.result)));
                                    this.ws.send(JSON.stringify({
                                        type: 'input_audio_buffer.append',
                                        audio: base64
                                    }));
                                };
                                reader.readAsArrayBuffer(event.data);
                            }
                        };
                        
                        this.mediaRecorder.start(100);
                        this.isRecording = true;
                        this.connectionStatus = 'listening';
                        this.addLog('info', 'Recording started');
                    } catch (error) {
                        console.error('Failed to start recording:', error);
                        this.addLog('error', 'Failed to start recording: ' + error.message);
                    }
                },
                
                stopRecording() {
                    if (!this.isRecording) return;
                    
                    this.mediaRecorder.stop();
                    this.audioStream.getTracks().forEach(track => track.stop());
                    this.isRecording = false;
                    this.connectionStatus = 'connected';
                    
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'input_audio_buffer.commit' }));
                        setTimeout(() => {
                            this.ws.send(JSON.stringify({ type: 'response.create' }));
                        }, 200);
                    }
                    
                    this.addLog('info', 'Recording stopped');
                },
                
                startPTT() {
                    if (this.voiceSettings.inputMode === 'ptt') {
                        this.startRecording();
                    }
                },
                
                stopPTT() {
                    if (this.voiceSettings.inputMode === 'ptt' && this.isRecording) {
                        this.stopRecording();
                    }
                },
                
                toggleMute() {
                    this.isMuted = !this.isMuted;
                    if (this.currentAudio) {
                        this.currentAudio.muted = this.isMuted;
                    }
                },
                
                interrupt() {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'response.cancel' }));
                    }
                    if (this.currentAudio) {
                        this.currentAudio.pause();
                        this.currentAudio = null;
                    }
                    this.isPlaying = false;
                    this.connectionStatus = 'connected';
                    this.addLog('info', 'Interrupt requested');
                },
                
                applySettings() {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({
                            type: 'session.update',
                            session: {
                                audio: {
                                    output: {
                                        format: { rate: 24000, type: 'audio/pcm' }
                                    }
                                }
                            },
                            tts: {
                                voice: this.voiceSettings.voice,
                                speed: this.voiceSettings.speed
                            }
                        }));
                        this.addLog('success', `Settings applied: voice=${this.voiceSettings.voice}, speed=${this.voiceSettings.speed}`);
                    }
                },
                
                clearConversation() {
                    this.conversation = [];
                },
                
                refreshProviders() {
                    this.addLog('info', 'Refreshing provider status...');
                },
                
                clearLogs() {
                    this.logs = [];
                },
                
                refreshLogs() {
                    this.addLog('info', 'Logs refreshed');
                },
                
                addLog(level, message) {
                    const now = new Date();
                    const time = now.toLocaleTimeString('en-US', { hour12: false });
                    this.logs.unshift({
                        id: 'l' + Date.now(),
                        time,
                        level,
                        message
                    });
                    if (this.logs.length > 100) {
                        this.logs.pop();
                    }
                },
                
                init() {
                    // Load theme preference
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme === 'dark') {
                        this.isDark = true;
                        document.documentElement.setAttribute('data-theme', 'dark');
                    }
                    
                    // Load available voices
                    this.loadVoices();
                },
                
                async loadVoices() {
                    try {
                        const response = await fetch('http://localhost:60200/v1/tts/voices');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.voices && data.voices.length > 0) {
                                this.availableVoices = data.voices.map(v => ({
                                    id: v.id,
                                    name: v.id
                                }));
                            }
                        }
                    } catch (error) {
                        console.log('Using default voice list');
                    }
                }
            };
        }
    </script>
</body>
</html>
